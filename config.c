#include "config.h"

int loadFanzoneConfig0()
{
	struct fanzone tempFanzones[FAN_ZONE_NUM] = {
		{
			{
				{0,1,1,1,1,1,1,1},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
		{
			{
				{0,21,22,23,24,25,26,27},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
		{
			{
				{0,21,22,23,24,25,26,27},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
		{
			{
				{0,0,0,0,0,0,0,0},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
	};

	memcpy((void *)&(currentConfig->fanzones),
           (void *)&tempFanzones,
           sizeof(struct fanzone) * FAN_ZONE_NUM);

    return 1;
}

int checkAndReturnFanzoneConfig0()
{
    struct entity_combination tempEntity = {
        { 0, 2 },
        { 5, 16 },
        { 6, 16 },
        { 9, 16 },
        { 10, 16 },
        { 11, 4 },
        { 13, 1 }
    };

    if (memcmp((void *)&(currentConfig->entity),
               (void *)&tempEntity,
               sizeof(struct entity_combination)) != 0)
        return 0;

    loadFanzoneConfig0();
    return 1;
}

int loadFanzoneConfig1()
{
	struct fanzone tempFanzones[FAN_ZONE_NUM] = {
		{
			{
				{0,21,22,23,24,25,26,27},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
		{
			{
				{0,21,22,23,24,25,26,27},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
		{
			{
				{0,21,22,23,24,25,26,27},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
		{
			{
				{0,21,22,23,24,25,26,27},
				{0.2,20,21,22,23,24,25,26},
				{0.4,20,21,22,23,24,25,26},
				{0.6,20,21,22,23,24,25,26},
				{0.8,20,21,22,23,24,25,26},
				{1,20,21,22,23,24,25,26}
			},
			{
				{0,21,22,23,24,25,26,27},
				{0.2,30,31,32,33,34,35,36},
				{0.4,30,31,32,33,34,35,36},
				{0.6,30,31,32,33,34,35,36},
				{0.8,30,31,32,33,34,35,36},
				{1,30,31,32,33,34,35,36}
			}
		},
	};

	memcpy((void *)&(currentConfig->fanzones),
           (void *)&tempFanzones,
           sizeof(struct fanzone) * FAN_ZONE_NUM);

    return 1;
}

int checkAndReturnFanzoneConfig1()
{
    struct entity_combination tempEntity = {
        { 0, 1 },
        { 5, 10 },
        { 6, 10 },
        { 9, 10 },
        {10, 10 },
        {11, 3 },
        {13, 1 }
    };

    if (memcmp((void *)&(currentConfig->entity),
               (void *)&tempEntity,
               sizeof(struct entity_combination)) != 0)
        return 0;

    loadFanzoneConfig1();
    return 1;
}

void get_system_fanzones()
{
	int i;
	int (*checkEntityThenReturnConfig[CONFIG_NUM + 1])() = {
		checkAndReturnFanzoneConfig0,
		checkAndReturnFanzoneConfig1,
		DEFAULT_CONFIG
	};

	for (i = 0; i < CONFIG_NUM + 1; i++) {
		printf("%s: Checking entity#%d...\n", __func__, i);
		if (checkEntityThenReturnConfig[i]() == 1)
			return;
	}
}

void get_system_entity()
{
	// [WIP] entity shall be retrieved at system startup,
	// use a temporary entity here. This shall be removed later.
	struct entity_combination temp4Config0 = {
		{ 0, 2 },
		{ 5, 16 },
		{ 6, 16 },
		{ 9, 16 },
		{ 10, 16 },
		{ 11, 4 },
		{ 13, 1 }
    };
    struct entity_combination temp4Config1 = {
        { 0, 1 },
        { 5, 10 },
        { 6, 10 },
        { 9, 10 },
        {10, 10 },
        {11, 3 },
        {13, 1 }
	};
    struct entity_combination temp4Default = {
        { 1, 2 },
        { 3, 4 },
        { 5, 6 },
        { 7, 8 },
        { 9, 10 },
        { 11, 12 },
        { 13, 14 },
        { 15, 16 }
    };

	memcpy(&(currentConfig->entity), &temp4Default, sizeof(struct entity_combination));
}

void *get_system_power_capping_info(void *vars)
{
	// [WIP] Leave this empty temporarily
	static float pc = 1.0;
	
	while (pc < 500000) {
		pc += 1.1;
		currentConfig->powerCapping =  pc;
	}
}
